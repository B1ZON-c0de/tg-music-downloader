# Telegram SoundCloud Music Downloader Bot

Бот для Telegram, который ищет треки на SoundCloud и скачивает их в MP3. Просто отправляешь название — получаешь аудиофайл.

## О проекте

Бот принимает текстовый запрос, ищет треки через API SoundCloud и показывает инлайн-клавиатуру с результатами. После выбора трек скачивается (через HLS или progressive-ссылку), добавляются ID3-теги с обложкой и отправляется пользователю.

Написан на TypeScript с использованием Grammy (Telegram Bot API фреймворк) и прямых запросов к SoundCloud API.

## Зачем я это сделал

Хотелось разобраться с неочевидными моментами в Telegram Bot API (работа с файлами, инлайн-клавиатурами) и заодно попробовать Grammy вместо привычного Telegraf. Ещё интересно было покопаться в том, как устроен стриминг у SoundCloud — почему одни треки отдаются через HLS, другие просто progressive, и как это обрабатывать.

## Функционал

- Поиск треков по названию через SoundCloud
- Вывод результатов в виде кнопок (исполнитель — название)
- Скачивание треков в MP3 с обложкой в тегах
- Автоматическая очистка старых файлов (не храним тонны музыки)
- Поддержка двух протоколов: progressive и HLS
- Обработка ошибок без падения бота

## Архитектура / Особенности реализации

Структура простенькая, но есть пара моментов, которые показались интересными:

- **Два подхода к скачиванию**: SoundCloud отдаёт ссылки либо на готовый MP3 (progressive), либо на HLS-плейлист. Для progressive просто стримим через axios, для HLS используем `m3u8stream`, который сам собирает сегменты в файл.

- **Кеширование**: перед скачиванием проверяем, нет ли уже файла с таким названием в папке `music`. Если есть — отдаём сразу, не дёргаем API.

- **Очистка старых треков**: после каждого скачивания запускается функция, которая сортирует файлы по дате изменения и удаляет лишние, если их больше `MAX_TRACKS`. Просто, чтобы диск не забивался.

- **ID3-теги**: после скачивания добавляем название трека, исполнителя и обложку через `node-id3`. Обложку вытаскиваем из `avatar_url` или `artwork_url`.

- **Обработка ошибок**: глобальный `bot.catch` ловит всё, что упало, и пишет в консоль + иногда отвечает пользователю, чтобы бот не молчал.

## Стек

- **TypeScript** — чтобы не гадать с типами на каждом шагу
- **Grammy** — работа с Telegram API
- **Axios** — HTTP-запросы
- **m3u8stream** — скачивание HLS-потоков
- **node-id3** — запись метаданных в MP3
- **dotenv** — конфиг через переменные окружения

## Как запустить

1. Клонируешь репозиторий:
```bash
git clone https://github.com/B1ZON-c0de/tg-music-downloader.git
cd tg-music-downloader
```

2. Ставишь зависимости:
```bash
npm install
```

3. Создаёшь `.env` файл на основе `.env.example`:
```
BOT_TOKEN='токен_от_@BotFather'
CLIENT_ID='client_id_soundcloud'
SOUND_CLOUD_URL_SEARCH='https://api-v2.soundcloud.com/search/tracks'
MAX_TRACKS='10'
```

Где брать `CLIENT_ID` — можно найти в сетевых запросах на сайте SoundCloud или погуглить, как его получать.

4. Собираешь и запускаешь:
```bash
npm run dev
```

Или сначала собрать, потом запустить:
```bash
npm run build
node dist/index.js
```

Бот запустится и будет ждать сообщений.

## Что можно улучшить

- Добавить возможность скачивать плейлисты (сейчас только отдельные треки)
- Поддержка прямых ссылок на треки (кидаешь ссылку — он качает)
- Нормальное логирование вместо console.log
- Тесты (но это уже совсем идеальный мир)